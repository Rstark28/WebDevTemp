<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Tic Tac Tango</title>
    <link rel="stylesheet" href="static/css/ttt.css">
</head>

<body>

    <h1>The Tic Tac Tango</h1>
    <div id="turn"></div>
    <div class="board"></div>
    <div id="condition">No Winner Yet</div>
    <button id="start-game">Start Game</button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const NUM_SQUARES = 9;
        let board = document.querySelector('.board');
        let currTurn;
        const winConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 4], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ];

        function updateTurn() {
            document.getElementById('turn').innerText = `${currTurn}'s Turn`;
        }

        function clearBoard() {
            currTurn = Math.random() < 0.5 ? 'X' : 'O';
            board.innerHTML = '';
            for (let i = 0; i < NUM_SQUARES; i++) {
                board.innerHTML += `<div class='square' id='${"sq" + i}'></div>`;
            }
            document.getElementById('condition').innerText = `No Winner Yet`;
            $('#condition').css('background-color', '#abb5df');
            updateTurn();
            runGame();
        }

        function checkWin(currBoard) {
            for (let i = 0; i < winConditions.length; i++) {
                const [a, b, c] = winConditions[i];
                if (currBoard[a] && currBoard[a] === currBoard[b] && currBoard[a] === currBoard[c]) {
                    return currBoard[a];
                }
            }
            if (currBoard.includes('')) return null;
            return 'S';
        }

        function runGame() {
            document.querySelectorAll('.square').forEach((square, index) => {
                square.addEventListener('click', () => {
                    if (!square.innerText) {
                        square.innerText = currTurn;
                        alert(`Square ${index} clicked`);

                        // Flatten the board state into an array of moves
                        const currBoard = Array.from(document.querySelectorAll('.square')).map(sq => sq.innerText);
                        const result = checkWin(currBoard);

                        if (result) {
                            if (result === 'S') {
                                document.getElementById('condition').innerText = 'Stalemate';
                                $('#condition').css('background-color', '#ffee8b');
                            } else {
                                document.getElementById('condition').innerText = `${result} Wins!`;
                                $('#condition').css('background-color', '#92d9a2');
                            }

                        } else {
                            currTurn = currTurn === 'X' ? 'O' : 'X';
                            updateTurn();
                        }
                    }
                });
            });
        }

        document.getElementById('start-game').addEventListener('click', clearBoard);
        clearBoard();
    </script>

</body>

</html>